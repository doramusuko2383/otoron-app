<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>パスワード再設定</title>
<link rel="stylesheet" href="style.css" />
<body class="app-root">
  <div class="login-wrapper">
    <h2 class="login-title">新しいパスワードを入力</h2>
    <form id="reset-form" class="login-form">
      <input type="password" id="new-password" placeholder="新しいパスワード" required />
      <input type="password" id="confirm-password" placeholder="もう一度入力してください" required />
      <p id="password-error" class="password-error" style="display:none;color:#e33;">パスワードが一致しません</p>
      <button type="submit" class="login-button">更新</button>
    </form>
    <p style="margin-top:20px;text-align:center;">
      <a href="/#login" class="login-secondary">ログイン画面に戻る</a>
    </p>
  </div>

  <script type="module">
    import { firebaseAuth } from "./firebase/firebase-init.js";
    import {
      verifyPasswordResetCode,
      confirmPasswordReset,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const params = new URLSearchParams(location.search);
    const oobCode = params.get("oobCode");

    const form = document.getElementById("reset-form");
    const newPw = document.getElementById("new-password");
    const confPw = document.getElementById("confirm-password");
    const errEl = document.getElementById("password-error");
    let valid = true;

    try {
      if (!oobCode) throw new Error("リンクが無効です（コードなし）");
      await verifyPasswordResetCode(firebaseAuth, oobCode);
    } catch (e) {
      valid = false;
      alert("リンクが無効です：" + e.message);
      [newPw, confPw, form.querySelector("button")].forEach(el => el.disabled = true);
    }

    function check() {
      const mismatch = newPw.value && confPw.value && newPw.value !== confPw.value;
      errEl.style.display = mismatch ? "block" : "none";
      form.querySelector("button").disabled = mismatch || !newPw.value || !confPw.value || !valid;
    }
    newPw.addEventListener("input", check);
    confPw.addEventListener("input", check); check();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (form.querySelector("button").disabled) return;
      try {
        await confirmPasswordReset(firebaseAuth, oobCode, newPw.value.trim());
        alert("パスワードを更新しました。ログインしてください。");
        location.href = "/#login";
      } catch (e) {
        alert("更新に失敗しました：" + e.message);
      }
    });
  </script>
</body>
</html>
